피드백 일정
마지막 잎새 팀이 먼저, 우리가 나중
전체 회의실 만들어지고, 각 합반 별 소회의실이 만들어질 예정

12.22 OT 진행 예정
회의실 3번에서 진행한다?

조정이 있을 수 있으니 강사님은 2시 반에 들어올 예정


브랜치 룰
프론트 만들때 domain 단위로 분리하고 feature로 판다.
프론트가 페이지별로 나뉘니까 이런 게 편한듯!


기능 개선
- API 타임아웃 추가
- 성공 메시지 만지기
- 에러 코드 만지기
- 정상 응답 테스트 안 돼있음 (충전소 데이터 의존성 가져서 이건 좀 기다리기)
- 문서화 안 된 거 있나?
- 

인프라가 준원님 쪽인데, 내가 손이 남으니까 이거 하기?
- dev, prod 환경 분리
	- docker compose
	- nginx
	- spring
- flyway 세팅? 해줄 순 있다.
- AWS 파이프라인?

---

역할 정하기

인프라 파트
- 도커 및 컴포즈
- 깃 리포지토리 세팅
- AWS
- 모니터링

백엔드 파트
- ERD
- API 명세

이게 가능한 사람

안지철
- 다 가능
- 1월 말 사라질 수 있음
안희건
- 코딩 정도만 가능, 형태만 알고 있다?
김민성
- AWS는 할 때 좀 오래 걸릴 듯
이준원
- 하라면 할 수 있다.
- 가이드라인 있어야 필요
김민규
- 할 수 있다 나라면
김에스더
- 코딩 쪼매 함니더
김유정
- 코딩 쪼매 함니더2
정준영
- 모니터링 힘드러영
신수호
- 모니터링 안해봣서용
- 팀에서 쓰는 건 안해봄

---

# 멘토링

내 질문

- 백엔드 측의 길찾기 API가 250~150ms 정도 걸리는 무거운 기능임. 때문에 MQ 또는 Redis Pub/Sub를 통해 안정적으로 트래픽을 제어해주려고 한다. 실무에서는 다른 방식을 어떤 것을 쓰는지? 또는 유의해야 할 것이 있는지?
> 아래 유사한 질문 존재함.

# 나온 것들

- 알림기능 RabbitMQ로 구현하려고 하는데 유의해야 할 내용이 있는지?
Producer/Consumer (큐) 오프셋 기능이 있음. 어디까지 읽었다. 
비정상적 실행 같은 것이 일어나서 오류가 생길 수 있음. 그럼 카프카는 다시 오프셋을 읽어주게 된다. 알림이 여러 개 나갈 수 있음.
채팅 시스템 기준으로 설명하는 것임. 카프카 디폴트 시간(10초)를 잡고, 메시지가 많아지니까 10초가 넘어지면 rebalancing(다시 읽기)
동일한 메시지가 3번 4번 나가는 것임!
이벤트 기반 라이브러리 쓰게 되면 부하 테스트 해보는 것을 추천.
멱등성 체크를 이용해서 실제로 보냈는지에 대해서도 생각 필요.
rebalancing에 의해 여러 번 나가는 이슈가 있었는데 도움이 된 포스트가 있다. [포스트](https://techblog.gccompany.co.kr/%EC%B9%B4%ED%94%84%EC%B9%B4-%EC%BB%A8%EC%8A%88%EB%A8%B8-%EA%B7%B8%EB%A3%B9-%EB%A6%AC%EB%B0%B8%EB%9F%B0%EC%8B%B1-kafka-consumer-group-rebalancing-5d3e3b916c9e)
많이 써보고 장애도 내서 해보고... 네이티브한 자바로 만들 수 있는지도 중요하다?
프레임워크를 쓰면 별로 고민을 안하지만 native한 코드를 짜면 이해도가 높아진다.
래빗큐도 비슷한 철학이 있을 것임.

- 외부 API를 사용 중임. 직접 구현하는 것과 다른, 의존 관계를 가지는 데 의존 서비스의 장애 시 대처를 어떻게 하는지? 서킷 브레이커 전략 같은 게 있다고 하는 데 어떻게 접근하는 지 궁금하다.

> 서킷브레이커란?
> 문제 생긴 기능은 끊어버리고 다른 대안 사용.

API 마다 성격이 다르다.
내부가 안되면 외부에서 다르게 처리해 줄 수도 있다? 최신하는 안되어 있겠지만?
끊을 수 없는 API들도 있다. 이에 대한 실수는 처리해줄 수 없으므로 방법은 없다. (기술적으로) alert 띄워서 네이버 페이 하세욧 이런 식으로 대응하는, 기술적 대응이 아닌 경우도 존재한다.
외부 API 호출에 대해서는 내부에서 저장하고 사용하는 것이 좋다 생각함.

외부 API 의존이 너무 높아져도 안되긴 한다.
그걸 지워버리면 큰일이 나기 때문에...
사업성으로 돈을 주고 쓴다거나 하면 노티가 오긴 한다.

바뀌지 않는 데이터는 내부에 들고 있는 게 제일 좋다.
객체에 대한 고유 키를 가져다 주는 데, 이걸 없어질 수도 있다.
우리도 동일하게 PK로 쓰다가 그걸 안쓰게 되면 큰일남. 그래서 내부 DB PK를 별도로 만들어줘야 한다.
내부 데이터에 대한 의존성이 높다면 위험하다.

> 그렇다면 들어올 때도 필드 체크를 정확하게 해주는 것이 중요한지?

네 맞워요
근데 null이 들어왔다고 해도 그걸 캐치할 수 있다면 가능한데, 안되면 에러 내는 것이 제일 좋긴 하다.
클라이언트는 계속 믿긴 해야한다. 아무리 Swagger, API spec을 쓰든 문제는 발생한다.

단순히 에러만 내는 게 아니라 롤백 같은 것들... 토스나 카카오 페이, 카카오 뱅크 같은 경우 잘 만들어둔다.
옛날 증권사 앱들은 에러 나면 뒤로가기 같은 거 엄청 어려운데... 코드 잘 짜려면 그런 것 까지 고려해야 한다?

복잡성이 높아지긴 하지만 그렇게 짜면 좋다.

> 서킷브레이커가 내부적 서비스가 떨어져도 사용할 수 있는 개념
> 로그인 시 토큰을 레디스에 저장, 관리.
> 레디스가 죽었다고 했을 때 어떻게 대응? rabbitMQ도 동일

Redis도 마스터 슬레이브가 나뉘어져 있다.
이중화되서 관리하는 방식
장애 경험이 없어서 고려를 많이 하지는 않지만, 장애 대응 전략이 있다!

RabbitMQ도 대응하는 전략이 존재함.

그 이외에 RDB에도 저장을 한다거나.
RDB에서도 별도 설정이 있을 것임. 죽었을 때 어디 노드로 붙어라...

클러스터가 싹다 죽었다? 이정도까지는 고려하지 않음.

챗지피티 싹다 내려감 까지 고려하는 경우도 있긴 한데 일반적으로 하지 않음.

인프라 고려가 필요하니 진짜 중요한 질문인듯.

RabbitMQ나 카프카는 이벤트 기반이기 때문에... DB에 무조건 저장을 하고 이벤트로 넘겨야 한다.
데이터 사이언티스트에게 줘서 분석을 해야겠습니다~ 이런 용도가 있기 때문에 어쨌든 RDB에 넘기긴 해야 한다.
로그로도 남겨둠.
RDB로 하기도 한다. 로그를 쌓고 싶다? 그렇다면 파일로 떨구고 elastic 서치로 최적화를 해주고 싶다는 것으로 들림.

걔네는 로그성이든 텍스트든, RDB든 어딘가에 쓰긴 한다.
그쪽에 조회해서 확인을 하긴 한다.
로그라서 잘 될진 모르지만, 그 정도 복잡성을 고려한다면 RDB를 써서 조금 느리더라도 가져오는 것이 좋다.

프로젝트를 취업이 잘 될 수 있는 방식?
RabbitMQ 써봤으니까 이벤트 기반으로 한다고 생각은 함. CQRS 패턴으로 해보는 것을 추천

참고자료. 커머스 쪽 CQRS 이벤트 패턴?

![[D4203A13-A3DB-435F-9C0E-8485A5BE0841.jpg]]

![[92384352-A248-47EE-A8C0-F74936F6D349.jpg]]
*CQRS 이벤트 기반 구성도*

![[BA89593D-333C-49D7-9482-D1E5A3C36022.jpg]]

application 이벤트 발행 방식에 대해 복잡성을 높게
장애 났을 때 어떻게 처리?



- API 공통 반환 규격을 따르나, response data의 필드값이 성공 혹은 대안에 따라 달라진다. 필드를 모두 표현하도록 통일하고 값이 없는 경우 null 형태로 만드는 것이 통상적으로 맞는지? 혹은 프론트엔드 측의 의견에 따르는지?

> Http Method가 200으로 동일함.

실패에 대한 Method는 다르게 해줌.
대안이라고 해도 실패이기 때문에, 200으로 보내면 안된다.
완전 퍼펙트한 것은 아니기 때문에 예시로 보내주겠지만 API 설계 규격서가 궁금하다면 Toss 결제 API 규격서 보면 된다.
일단! 상태 코드는 분리 필요함.

키는 보내긴 한다.
null 보내지 말고 빈 값 보내는 것이 좋다.
프론트에서 잘 처리할 수 있게 해주고...

SCode
성공 코드와 실패 코드를 enum으로 별도 관리

[글](https://velog.io/@yangtaeyoung93/%EC%9B%90%ED%8B%B0%EB%93%9C-%ED%94%84%EB%A6%AC%EC%98%A8%EB%B3%B4%EB%94%A9-%EB%B0%B1%EC%97%94%EB%93%9C-31%EC%B0%A8-%EA%B0%9C%EB%B0%9C-%ED%9A%8C%EA%B3%A0-CQRS-%EA%B8%B0%EB%B0%98-%EC%9D%B4%EC%BB%A4%EB%A8%B8%EC%8A%A4-%EC%84%A4%EA%B3%84-1%EC%A3%BC%EC%B0%A8-1)

> 생각한 이유
> 일단 트랜잭션 성공한 걸로 판단함

근데 사용자 측은 정확한 데이터를 원한다.
이건 외부적 실패니까 실패에 대한 것도 분리를 해주긴 해야 한다.
외부 API에 대해 실패했으니 로그를 남기거나, sCode:5004와 같이 메시지 별도 만들어서 이거 만들면 프론트가 alert으로 써줄 수 있다.

HTTP 실패에 대해 4xx, 5xx를 쓰는 것에 2xx로 처리해버리면 모니터링할 때 스카우터가 에러로 안찍어줄 수 있다. 성공 아닌 이상은 Http 상태 코드에 맞게 하는 것이 좋다.


- 하나의 기능에서 두 개의 외부 API를 사용한다. 타임 아웃 후 재시도 기능을 구현하게 되면 최악의 경우 트랜잭션이 굉장히 길어질 것 같은데 읽기 타임아웃은 전체 트랜잭션 기준으로 설정해줘야 하는지? 아니면 각 API 마다 설정해줘야 하는지?

사용자, 길찾기는 하나의 트랜잭션?
> ㄴㄴ 하나

> 타임아웃은 각자 API에 걸어줘야 하는지? 

일단 API 두개가 꼭 한번씩 호출해야됨?

참 애매하다.

주소 변환은 내부에서 처리할 방도가 없을까?

타임아웃은 해당 외부 API를 기준으로 더 넓게 하는 수밖에는 없을 것 같음.
> 각자 걸어주는 게 맞는지?

ㅇㅇ 각자보다 넓게 해서 받아주는 게 맞음.
내부 API 호출도 있는데, 얘도 내부에서 호출하는 것들도 그것에 더한 만큼 타임아웃 해줘야 된다.


- 배포하면서 이런 게 좋았다 추천할 만한 것이 있는지?

> 운영에 약해서 우리 운영 팀이 하는 것들 알려드림

도커 컴포즈 이용해서 쏘기는 한다.
깃 액션은 잘 모르겠고, ssh는 잘 답변을 못해주겠다.
컴포즈 이용해서 배포를 하는 것 같은데 장단점에 대해서는 잘 모르겠다.

-  브랜치 전략을 합의를 해서 사용중인데, 실무에서는 어떻게 사용하는지?
GitLab에서 이슈나 피처, 제안서? 리포트 등이 올라오면 고유 번호에 맞게 GitLab 브랜치를 생성한다.
통합 기획에 대한 내용이 GitLab 도메인에 있다. 이러면 번호 4번일 때 브랜치 이름은 4번으로 생성한다.
작업이 종료되면 test 브랜치에 push하고 개발서버에 배포해서 개발자나 테스터(QA)가 테스트하고, 4번에 있는 것을 운영 전 dev 브랜치에 머지해서 배포하는 날이 월요일이면 그 브랜치를 master에 붙여서 배포함.

dev에서 test를 하는 것으로 보이는데, 나중에 꼬일수도 있다.
따라서 test 브랜치를 하나 더 두는 전략이 낫지 않나 싶음.

브랜치 자체는 우리 회사에서 운영하는 것과 똑같다.
이슈에 대한 브랜치를 따는 건데, 전략 보면 비슷한 거 같고...
브랜치별 topic은 잘 나눴다. feature, bug, fix...
결국 prod에 들어갈 건데, 몇 개를 빼야할 수 있다. merge를 잘못하게 될 수도 있고... 따라서 test 브랜치에 작업물을 넣어보고 test 브랜치 만의 별도 브랜치를 따서 개발 도메인 하나 만들어서 test 다 끝나면 user 브랜치를 dev에 머지하게 된다.

stage 브랜치가 하나 더 있긴하다.

> 배포가 되는 게 있고 운영까지 가는 이슈, 가지 않는 이슈가 있다.
> 이걸 걸러내는 게 dev인지? 무조건 모든 브랜치 커밋 푸시는 dev까지 간다. 그렇다면 운영에 갈지 말지 정하는 건 stage인가?

제일 우선적으로 중요한 부분이 test 브랜치는 개발자들이 보는 것들이다.
첫번째로 stage 테스트를 하는 이유는 feature 최종 테스트도 맞다.
두 번째로 원형 데이터를 dump 떠서 넘겨야된다.
개발 환경 DB 따로, 배포 환경 따로 있다.

보안 이슈때문에 회원 정보 마스킹 처리하긴 하는데 비용이 많이 들어서 개발환경 DB 까지만 처리해준다.
최종 처리는 staging이 맞다.
test 브랜치 끝나면 dev에 넣고 master 반영하면 안됨? 해서 우리는 그렇게 했다.

굿닥 QA 할 때도 꽤 운영하던 회사였음에도 staging을 안만들었었따.
이 DB 만드는 비용이... 쉽지 않게 비쌈.

DBA 덤프가 비쌈...

> Dev 운영으로 가는 건 브랜치 단위로 뽑아내는지?
> 운영으로 가면 안되는 건 어떻게 걸러냄?
> 단위를 어떻게 잘라내는 지가 궁금함.

Dev에 올린다는 의미는 무조건 반영한다는 것임
회사 브랜치 전략이라서 회사마다 다르긴 하지만!

시니어 와가지고 배포? 말아? ㄱㄱ 하는 식으로 의견 정리된다음에 배포

핫픽스 같은 거 스테이징 하고 테스트 하면 제일 퍼펙트인데 개비싸서 문제가됨.

사람이 이것 빼고 이것 넣고 배포해주세요 이런 전략이 아마 있을 거임. 근데 우린 안써봄.
Slack 같은 곳에서 우리는 처리한다.

- 만약 테스트 서버까지 괜찮아서 Dev 머지하려고 했는데 이상이 생기면 test 브랜치는 지우는지?

스테이징이 있으면 테스트에서 괜찮은데 개발이 이상할 때 커밋 하나 생성해서 수정해도 된다.
테스트는 날려도 상관이 없다.

근데 물어는 봐야 됨.
배포 예정인 분들 중에 내가 테스트 깨져서 날릴 것 같은데 날려도 되겠습니까. 물어봐야됨

혹시 깃 충돌에 대해 말하는 건지?
혹은 소스코드가 잘못되서 오류가 생긴 것 말하는 것인지?

충돌나면... 어떻게 하심?
> 코드 작업자랑 서로 협의하면서 합치고 날린다.

네... 저희도 그렇게 합니다...

Git hook 같은 것도 실수할 수 있으니 한 번 써볼 것.


Github actions 같은 건 매우 자동화해서 사용하지는 않는 것 같음.
충돌 병합은 충돌난 곳 개발자들 물어보고 합침...

> 배포리스트도 작성하는지?

배포 리스트도 작성한다.
깃 이슈 생성해서 저 이거 담주 월요일 배포 예정... 시니어, 상무 올라올라 이거이거 배포구나 ㅇㅋ~
운영팀이 배포 리스트 한 번 확인하고 체크업... (잘 아는 사람이면)

- API 키, 환경 변수 같은 것들을 gitIgnore에 올려서 공유하고 있다.
  어떻게 관리해야 하는지?
이것들은 바로 IP로 나오면 안되고, 암호화를 한 번 돌려야 함.
스프링은 알아서 decrypt 해주는 세팅도 있다.

일단 properties 이 파일 자체는 평문으로 존재하면 안됨!!!

> 개발자들 끼리 이런 환경변수를 공유할 때 어떻게 해야하는지?

환경변수가...
리포지토리 자체를 private 하게 만들 수도 있다.
collaborater만 접근할 수 있으니 넣어도 상관이 없다!!!

DB 정보 같은 것들은 우리끼리 알아도 한 번 더 감싸자는 것임.

> 암호화하는 툴이 있는지?

자바 객체 생성 후 암호화 툴 이용해서 암복호화하고... 그러는 툴이 따로 있다.

```
StandardPBEStringEncryptor pbeEnc = new StandardPBEStringEncryptor();
```

application profile도 master, dev, test 다 나눠서 관리함.
공통된 건 application.yml로 관리해도 되고.


- 공공데이터 전화 해봄. 가변할 수 없는 키값 달라 했는데 ㄴㄴ 그런거 안됨. 답변옴. 그럼 님들은 그거 어케암? 거기서도 취합만해서 데이터 싹 다 날리고 저장해준다고 함.

> 업데이트하려면 전체가 다 키가 되어야 한다.
> 이거 어떻게 해요???

내부적으로 키를 유지를 해야 한다.
우리가 이걸 안 쓴다라고 하면 안써도 되는데...
외부적으로 키가 바뀌니까 이걸 못쓴다.

외부 데이터가 들어오면 내부에선 이것의 키를 못쓴다. 키 명은 동일하게 쓸 꺼니까...

전부 날리고 생성하는 게 제일 나을 듯

> 강사님 난입
> 주소 PK 생성
> 다른 테이블에 넣어서 정리해야 할 것 같음.
> 통상 PK는 없고 위경도로 일단 비교

위경도
AB로 분리값 하나 넣고

사용자가 즐겨찾기 같은 거 해버리면 깨져버리니까... PK가 바뀌면 그게 바뀐다.
따라서 위경도는 남겨두고 따로 충전소는 관리해줘야 한다.
