
네이밍 컨벤션

예상 사용자?
성능 요구사항
hw 스펙?


프로젝트 레퍼런스?

angular.js에서 만든 커밋 전략 그대로 따라한 걸 따라한다.


자기 기능 시퀀스 다이어그램 짜오면 될듯
Mermaid로 작성 가능

자기 도메인에 대한 것들, 마주한 버그들 정리해서 발표자료화 시켜야됨.


---

쿠폰 기능

쿠폰 정책
중복 사용? 공식

선착순 쿠폰 -> sse? 알람 필요?


chartDB

오늘 목표
api spec - 응답/요청까지
ERD




결제 시 쿠폰 할인 순서?

1. 장바구니 결제
2. 주문 생성
3. 쿠폰 사용 (정책 적용) 후 최종 결제 금액 정산
4. 결제 기록 생성
5. 결제 완료!


쿠폰 테이블 안에 % 또는 차감액
amount로 enum보고 %로 계산 또는 산술적 계산

쿠폰 사용도 개별 품목? 전체 품목 적용할 지?

쿠폰 여러 개 사용인 줄 알았는데 낱개 사용이었음.
여러 개 사용... 도전!
하면 계산 식이 어떻게 될까?

1. 일단은 낱개 사용
2. 리팩토링 하면서 다중 사용 하는 거 어떰?


추첨이 프로덕트 개념이여야 할 듯
분리해야 될 지도...

추첨권은 어떻게 관리해주어야 할까
티켓 이름으로 넣어놨을 때 참조해서 갖다써야하면 참조할 게 늘어난다.
이게 맞나...?

뭘 product로 넣어야 하지?
추첨권을 상품으로 볼까?

raffle은 일단 상품화한다.




추첨 프로세스
- 뇌가 빙빙 돈다
- 일단 추첨을 프로덕트에 넣고 잘... 어떻게 해준다.
- 프로덕트에 추첨용 상품 추가됨. state로 구분해줌.

알람 프로세스
- 장바구니 품목에 대한 알람
- 만약 장바구니 안에 있는 물품의 개수가 부족해지면 알람 보내자!
- Order 뿐만 아니라 Cart도 새로 만듬.
- 

쿠폰 프로세스
- 선착순 받기
- 사용 기록 추적은... 알잘딱갈센
- 단일 사용


쿠폰 정책 딥하게
시나리오
정책
단수, 복수
(원가 `*` 곱연산) - 합연산
100원 단위로 올림 연산함.

단일 상품에 대한 쿠폰 적용의 경우
무조건 쿠폰은 단일 타입임.
따라서 한다면 주문도 따로따로 시켜야함.



타입 - 단일 사용
하나만 쓸 수 있음.
쿠폰 사용함? ㅇㅋ
규칙 뭐임?
룰 간단


복수 사용
여러 쿠폰 조합 가능.
위의 규칙 적용



단일 상품에 대한 쿠폰

추첨권 타입?
특정 상품에 대한 할인률 적용
- 그럼 특정 상품 말고도 특정 유형에도 적용할 수 있을 듯?

타입 - 단일 상품
그럼 FK같은게 있어야 할 것임.



카트 장바구니
오더 주문


notification 어떻게 할 계획?
프로덕트랑 유저와 연결됨.
A유저와 품목 연결. 하나의 품목이 임계점에 도달 시 A유저에게 부족해졌다라는 알림 보내는 로직.
연결방식 논의 필요할 듯.
세션? jwt? sse 쓰면 어떻게 될지


일단 쿠폰은 하나만 사용하는 방식으로 쓰고 2차때 여러 개 쓰는 건 민성님이랑 상의하는 식으로 리팩토링 하기


---

Today todo

시퀀스 다이어그램(유저 플로우) 정의
개발하면서 참고하면 좋을 듯




raffle 티켓 추첨 -> 티켓 결제한 사람 대상
raffle tickets
쭈루루 나온다.

티켓 결제 한 사람 판별해줘야 하는데 estimatments
근데 래플은 프로덕트 안쪽에서 관리를 해준다.
결제 시 기존 결제된 것들은 프로덕트 quantity로 차감.
티켓의 경우, quantity 차감 뿐만 아니라 raffle 티켓까지 업데이트 필요
품목에 따라 다 동일하게 어떻게 해야 할까?

품목에 따라 업데이트 해주는 곳이 다르다.

장바구니에 넣어줘야 한다.
결제여부 플래그 업데이트가 문제다.


결제 서비스에 프로세스

장바구니 안에 티켓이 들어가야 한다!!!!!!!!!


# 이슈

준원님 ERD 만들던 중 이슈
raffle_tickets 필드로 is Payment가 있는데
이게 구매하면 상태 변경하고 raffles의 필드 차감도 같이해줘야 해서 매우 곤란함.
업데이트가 여러 번 되어야 한다.

근데 이게 마땅한 방법이 없다. isPayment 쓰거나 결제에서 메서드를 두 번 파야함.
결제 쪽에서 여러 번 만드는 것으로 결정되었음.

결제에서 티켓 판단해서 걸리는 거 있으면 raffles 티켓까지 타고 들어가서 테이블에 레코드 넣을 수 있게끔 해주기?
raffle에 product id를 붙여서 product id, user id로 어떻게든 타고 들어가게 만든다.
어떤 유저가 만들어야 되는지는 알아야 하고, 어떤 유저가 했는지 알아야 함.
이 티켓이 어떤 raffle에 해당하는지. 총 3개 정보

---

api는 일단 폴더 트리 구조가 DDD로 되었으니 이거 최대한 맞춰서 따라가보자.

API spec

coupon
발급받기
`/coupon/issue/{coupon_id}`

쿠폰은 결제 시 사용.
결제에만 사용하는 쿠폰 유형만 존재하나?

내 쿠폰 조회
`/coupon/me`
아직 사용하지 않은 쿠폰만
만료되지 않았고, 사용 가능한 조건으로만 보여줌.

~~쿠폰 내역 조회~~
굳이.... 해줘야 할까? 일단 지금은 미정임.
`/coupon/me/history`
options : gained=`boolean`&used=`boolean`&from=`date`&to=`date`
쿠폰 받은 기록 + 사용한 기록 모두 보여줌 (옵션 검색)
사용 여부만 보기, 획득 여부만 보기, 특정 기간만 보기 선택 가능

