주간일지 작성

쿠폰 발급 시 직렬화 및 키
coupon-item-cache::1
couponIssueId를 기준으로 한다. 접두사를 붙여서 사용중이다.
userId가 null인 문제 존재.
직렬화
```
["groom.backend.interfaces.coupon.dto.response.CouponIssueResponse",{"couponIssueId":1,"couponId":1,"userId":null,"createdAt":[2025,11,14,11,46,14,275517700],"deletedAt":[2025,11,20,0,0],"couponType":"PERCENT","discountValue":43,"maximumDiscount":null,"minimumCost":null,"isActive":true}]
```



---
쿠폰 할인 결제창 미적용


쿠폰 발급 시 쿠폰이 갱신되어야 한다. List에 감싸진 경우 갱신 못하니까 파기시켜야 하는데 못해주는 문제가 존재한다.
그래서 CacheEvict로 쿠폰 발급 시 파기하도록 설정함.

Cache-Aside Batch Read 전략 사용

이 미친 캐싱은 무엇을 캐싱하냐에 따라 다를 건데, 쿠폰 자체를 캐싱해주었다.
여러 개를 관리해주어야 하는데 하기 어려우므로, 여러 개 가지고 있다가 레디스에서 없는 거 꺼내오는 전략이다.
calculateDiscount()에 구현되어 있다. 캐시 히트/미스 분리하고 필요한 것만 가져오게 해두었다.



트러블 슈팅

# 결제 시 쿠폰 사용이 동작하지 않는 문제

결제 시 쿠폰이 사용되지 않는 문제가 발생하였다.
3번은 특히 엣지케이스를 간과하고 있었다가 시간차를 두고 터져버렸다..

## 1. FE 기능 미구현

간단하다. 장바구니에서 결제 창으로 넘어갈 때 정보가 없어 넘어가지 않는 문제이다.
커서를 통해 해결했다.

## 2. 직렬화 문제

```
org.springframework.data.redis.serializer.SerializationException: Could not read JSON: Cannot deserialize value of type `groom.backend.interfaces.coupon.dto.response.CouponIssueResponse` from Array value (token `JsonToken.START_ARRAY`) at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]
```
에러 로그의 일부이다.

원인은 시리얼라이저가 작동할 때 클래스와 객체 데이터를 배열 형태로 저장하는 것으로, 그 때문에 받아야 하는 객체는 CouponIssueResponse인데, JSON 배열 객체가 있어서 오류가 나는 것이다.

수동으로 캐싱하여 해결해주었다.

그리고 수동 설정 잘 해주고 Mset으로 설정해주려 했더니 ttl이 안된채로 나간다.
https://stackoverflow.com/questions/16423342/redis-multi-set-with-a-ttl
스택 오버플로우를 보면 무려 12년 하고  6개월된 문제이다.



## 3. 정책 엣지 케이스

다중 캐시 사용 정책은 List에 담겨 for 루프 또는 stream API를 통해 이루어진다.
다중 캐시 사용이 가능한 쿠폰 정책은 비율, 정액 할인 두 가지이며, 얼마나 올 지 모르기 때문에 각 정책을 리스트에 담아 보관하고 처리하는 방식으로 작동했었다.
문제가 되는 부분은 `list.get(0)`부분 이었다.
두 정책 중 하나가 비어있을 경우를 간과한 것인데, 이 때문에 리스트가 비어있다는 오류가 생겼었으며 초기에는 데이터가 제대로 오지 않는 것으로 판단했다.

로그를 흘려본 결과 데이터는 정상적이었고, 정책 반환 코드를 보고 문제를 알아차릴 수 있었다. 후...