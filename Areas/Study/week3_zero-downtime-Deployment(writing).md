

# 무중단 배포
소프트웨어 시스템 업데이터나 배포 과정에서 서비스 중단 없이 새로운 버전 배포하는 방법.
사용자에게 서비스를 계속 제공하며 시스템을 업데이트할 수 있는 방법을 제공하여 가용성과 신뢰성을 높인다.

**여기서 의미하는 가용성과 신뢰성?** with GPT
가용성(Availability)
- 시스템이 정상동작하여 사용 가능한 상태를 유지하는 비율
 무중단 배포와의 관계
- 무중단 배포를 통해 **서비스가 배포 중에도 계속 응답**할 수 있음
= 배포 과정 중에도 서비스 다운타임 없음
- 예: 배포 중에 로그인, 상품 조회, 결제 등 기능이 **멈추지 않고 동작**

신뢰성(Reliability)
- 시스템이 오랜 시간 동안 오류 없이 안정적으로 작동할 수 있는 능력
무중단 배포와의 관계
- 무중단 배포는 보통 **자동화된 테스트, 헬스체크, 점진적 적용(카나리아/롤링)** 등의 메커니즘을 사용
- 이로 인해 **새 버전 배포 후에도 시스템이 안정적**이고 **예측 가능**함
= 배포 후에도 시스템이 이전처럼 "안정적으로 잘 동작"


## 주요 특징

1. 가용성 유지
   시스템이 배포되는 동안에도 사용자는 서비스를 계속 사용할 수 있습니다.
2. 신속한 롤백
   새로운 배포가 문제가 있을 경우, 신속하게 이전 버전으로 롤백할 수 있습니다.
3. 점진적 업데이트
   새로운 기능을 점진적으로 배포하여 문제가 발생할 가능성을 줄입니다.

장단점 (with GPT)
### 장점

1. 높은 가용성
    - 배포 중에도 지속적으로 사용자 접속이 가능하므로, 24/7 서비스가 필요한 환경에 적합합니다.
        
2. 위험 감소
    - 점진적 업데이트와 신속한 롤백으로 인해 배포 과정에서 발생 가능한 위험을 줄일 수 있습니다.
        
3. 빠른 피드백
    - 새로운 기능이나 버그 수정 효과를 빠르게 확인 가능합니다.

### 단점

1. **구현 복잡성**
    - 로드 밸런싱, 버전별 인프라 병행 운영, 데이터 마이그레이션 동기화 등의 설계가 필요합니다.
        
2. **비용 증가**
    - 블루-그린 구조처럼 두 세트의 인프라를 동시에 유지해야 하는 경우 비용 부담이 커집니다.
        
3. **데이터 일관성 문제**
    - 배포 중 구버전과 신버전이 동시에 동작하면, DB 스키마 변경 시 호환성 문제가 발생할 수 있습니다.
        
4. **운영 및 모니터링 부담**
    - 다중 버전 동시 운영 시 로그, 모니터링, 트래픽 분배 관리가 복잡해집니다.
        
5. **환경 제약
    - 레거시 시스템이나 세션 상태를 서버 메모리에 저장하는 구조에서는 무중단 배포 구현이 어렵습니다.


## 대표적인 방법

- 롤링 배포 (Rolling Update)
- 블루-그린 배포 (Blue-Green Deployment)
- 카나리 배포 (Canary Deployment)


### 롤링 배포 (Rolling Deployment)

**롤링 릴리스**(rolling release), **롤링 업데이트**(rolling update), **지속적 배포**(continuous delivery)라고도 한다.

---

*시작하기에 앞서 잠깐 릴리즈라는 개념으로 잠시 들어가보자.*
*버전 관리라는 측면으로 보는 것이니 맥락이 크게 변하지는 않을 것이다.*

잘 알려진 방식은 두가지가 있다.
**롤링 릴리즈** - 앞서 설명한 개념이다.
**포인트 릴리즈** - 이제 설명할 개념이다.

**포인트 릴리즈**는 버전을 이용해 릴리즈하는 방식이다.
i.e. Linux, Windows
예시로 든 운영체제 뿐만 아니라 소프트웨어 대부분이 릴리즈할 때도 사용하는 방식이다.

몇 가지 특징들이 온다.
- **새로운 버전 적용을 위해, 새로운 설치가 필요함.**
- **이전 버전의 제품은 EOL(End of Life, 지원 종료)을 가지며, 각 버전에 대한 업데이트가 필요함.**
- **EOL 시점이 오면 해당 버전은 업데이트가 없음.**

버전 관리라는 유지 비용이 생기지만, 오래된 하드웨어에 대한 지원이 가능하므로 마냥 나쁜 것은 아니다.

이제 버전 관리 측면에서의 **롤링 릴리즈**를 알아보자.
롤링 릴리즈는 포인트 릴리즈와는 다르게, 버전이라는 개념이 존재하지 않는다.
조금의 변경이 발생하더라도 바로 릴리즈하는 방식이기 때문에, 버전 변화가 너무도 빨라 명시하지 않는다.

대표적으로는 아치 리눅스(Arch Linux)가 롤링 릴리즈 방식을 채용한다.

특징은 다음과 같다.
- **버전 개념이 없기 때문에 새로운 설치를 할 필요가 없음.**
- **EOL이 존재하지 않음.**

빠른 릴리즈 주기를 대가로, 오래된 하드웨어에 대한 지원을 포기한다는 단점이 있다.

> 버전 관리 관점에서의 개념은 충분히 보았다! 더 깊은 내용은 추가적으로 공부하고,이제 서비스에서 배포하는 측면으로 돌아와보자!

---

![](https://cdn.prod.website-files.com/6171016af5f2c575401ac7a0/667bc30effd7bd92ebcd93a4_6645bea6cc736d8c99824a6a_ImageryEppo_1.png)
[geteppo - what is rolling deployments](https://www.geteppo.com/blog/what-are-rolling-deployments)

![rolling-deployments-schema.png](rolling-deployments-schema.png)
[Koyeb - CD explained](https://www.koyeb.com/blog/blue-green-rolling-and-canary-continuous-deployments-explained)

서비스를 하면서 기능에 변경이 생기면 업데이트는 필연적이며, 업데이트를 하는 동안에는 서비스를 사용할 수 없다.
보통 서비스를 하는 기업들은 2개 이상의 서버를 가진다.
'*그렇다면 한 번에 몇 개만 순차적으로 업데이트한다면 서비스를 유지하면서 업데이트를 할 수 있지 않을까?*' 라는 아이디어이다.

기본 개념
- **순차적 업데이트**
  한 번에 전체 인스턴스가 아닌, 일부 인스턴스 씩 차례대로 업데이트한다.
- 가용성 유지
  업데이트 중에도 서비스는 계속 제공됩니다.
- **자동 롤백**
  문제 발생 시 업데이트를 중단하고 이전 버전으로 롤백할 수 있습니다.


**예제 시나리오**
> 클라우드 기반의 채팅 애플리케이션이 버전 3.0에서 버전 3.1로 업데이트될 예정입니다.

| 구분                 | 시나리오                                                                                                                                                            |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **초기 상태**          | - 클러스터에는 5개의 인스턴스가 있으며, 모두 버전 3.0이 운영 중입니다.<br>- 인스턴스 목록: [Instance A (v3.0), Instance B (v3.0), Instance C (v3.0), Instance D (v3.0), Instance E (v3.0)]       |
| **롤링 업데이트 시작**     | - 한 번에 하나의 인스턴스를 새로운 버전으로 업데이트합니다                                                                                                                               |
| **첫 번째 인스턴스 업데이트** | - Instance A를 버전 3.1로 업데이트합니다.<br>- 인스턴스 목록: [Instance A (v3.1), Instance B (v3.0), Instance C (v3.0), Instance D (v3.0), Instance E (v3.0)]                    |
| **모니터링 및 검증**      | - Instance A의 상태를 모니터링하여 새로운 버전이 정상 작동하는지 확인합니다.                                                                                                                |
| **두 번째 인스턴스 업데이트** | - Instance A가 안정적이면, Instance B를 버전 3.1로 업데이트합니다.<br>- 인스턴스 목록: [Instance A (v3.1), Instance B (v3.1), Instance C (v3.0), Instance D (v3.0), Instance E (v3.0)] |

장점
- **고가용성**: 서비스 중단 없이 배포를 진행할 수 있습니다.
- **점진적 변경**: 점진적으로 업데이트를 적용하여 문제 발생 시 영향을 최소화할 수 있습니다.
- **신속한 롤백**: 문제가 발생한 인스턴스만 롤백하여 전체 시스템의 안정성을 유지할 수 있습니다.

단점
새 버전 전환 중 실서비스에 대응되는 인스턴스 수가 감소하기 때문에 트래픽이 몰릴 수 있습니다.
서비스 처리 용량에 대한 고려가 필요합니다.
배포 진행 간 구/신 버전 공존으로 호환성 문제가 발생할 수 있습니다.

### 블루-그린 배포 (blue-green deployment)

![[blue-green-deployment-schema.png]]
![blue-green-deployment-schema.png](blue-green-deployment-schema.png)

블루, 그린 두 개의 환경을 이용하여 무중단으로 애플리케이션을 배포하는 전략이다.

기본 개념
- **블루 환경(Blue Environment)**
  현재 운영 중인 프로덕션 환경입니다.
- **그린 환경(Green Environment)**
  새로운 버전을 배포하고 테스트하는 환경입니다.

**예제 시나리오**
> 전자상거래 웹사이트가 버전 1.0에서 버전 1.1로 업데이트될 예정입니다.

| 구분               | 시나리오                                                                                                                   |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **초기 상태**        | - 블루 환경: 버전 1.0이 운영 중.<br>- 그린 환경: 미사용 상태.                                                                             |
| **새로운 버전 배포 준비** | -  개발팀은 그린 환경에 버전 1.1을 배포하고 필요한 모든 테스트를 수행합니다.                                                                         |
| **테스트 완료**       | - 그린 환경에서 버전 1.1이 정상적으로 작동하는지 확인합니다.<br>- 모든 기능 테스트 및 성능 테스트가 완료되면 다음 단계로 진행합니다.                                       |
| **트래픽 전환**       | - 로드 밸런서를 사용하여 블루 환경에서 그린 환경으로 트래픽을 전환합니다.<br>- 전환 시점에서 사용자는 서비스 중단 없이 새로운 버전(1.1)을 사용하게 됩니다.                          |
| **모니터링 및 안정화**   | - 그린 환경에서 운영을 시작한 후, 모니터링을 통해 문제가 없는지 확인합니다.<br>- 만약 문제가 발생하면, 신속하게 로드 밸런서를 다시 블루 환경으로 전환하여 롤백할 수 있습니다.                |
| **블루 환경 업데이트**   | - 그린 환경이 안정적으로 운영되면 블루 환경을 새 버전으로 업데이트하여 다음 배포 준비를 합니다.<br>- 이제 그린 환경이 현재 프로덕션 환경이 되고, 블루 환경이 새 버전을 배포할 준비가 된 상태가 됩니다. |

장점
- **무중단 서비스**: 사용자는 배포 과정에서 중단 없이 서비스를 이용할 수 있습니다.
- **신속한 롤백**: 문제가 발생하면 즉시 이전 버전으로 롤백할 수 있어 위험을 최소화합니다.
- **테스트 용이성**: 실제 프로덕션 환경과 동일한 조건에서 새 버전을 테스트할 수 있습니다.

단점
시스템 자원이 2배 필요하며 비용 문제가 있을 수 있어 소규모 프로젝트에 적용하기 어렵습니다.


### 카나리 배포 (canary deployment)

![canary deployment](canary-deployments.png)

새로운 소프트웨어 버전을 전체 사용자에게 배포하기 전에 소수의 사용자에게 먼저 배포하여 시스템의 안정성과 성능을 검증하는 전략

소수의 사용자를 대상으로 일종의 베타 테스트를 시행해 안전한지 확인하기 때문에 카나리아(canary)라는 이름이 붙었다! 마스터-슬레이브 급의 작명센스이다.

기본 개념

- **카나리 인스턴스**: 새로운 버전이 배포되는 소수의 서버 또는 환경입니다.
- **전체 인스턴스**: 기존 버전이 배포되어 있는 대부분의 서버 또는 환경입니다.
- **트래픽 비율 조정**: 카나리 인스턴스로 보내는 트래픽의 비율을 점진적으로 증가시킵니다.

## 예제 시나리오

**시나리오**: 소셜 미디어 애플리케이션이 버전 2.0에서 버전 2.1로 업데이트될 예정입니다.



| 구분               | 시나리오                                                                                                                          |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| **초기 상태**        | - 전체 인스턴스: 버전 2.0이 운영 중.<br>- 카나리 인스턴스: 미사용 상태.                                                                               |
| **새로운 버전 배포 준비** | - 카나리 인스턴스에 버전 2.1을 배포하고, 초기 테스트를 수행합니다.                                                                                      |
| **카나리 배포 시작**    | - 전체 사용자 중 일부(예: 5%)만 카나리 인스턴스(버전 2.1)로 트래픽을 전달합니다.<br>- 나머지 사용자(95%)는 기존 전체 인스턴스(버전 2.0)를 사용합니다.                             |
| **모니터링 및 검증**    | - 카나리 인스턴스의 성능, 안정성, 오류 발생 여부 등을 모니터링합니다.<br>- 새로운 버전(2.1)이 안정적이면 다음 단계로 진행합니다.<br>- 만약 문제가 발생하면 카나리 배포를 중단하고, 기존 버전으로 롤백합니다. |
| **트래픽 비율 증가**    | - 카나리 인스턴스가 안정적임을 확인한 후, 카나리 인스턴스로 보내는 트래픽의 비율을 점진적으로 증가시킵니다.<br>- 예: 10%, 25%, 50%, 75%, 100% 순으로 비율을 늘립니다.                  |
| **전체 배포 완료**     | - 모든 트래픽을 카나리 인스턴스로 전환하여 버전 2.1을 전체 인스턴스로 배포합니다.<br>- 이제 모든 사용자가 버전 2.1을 사용하게 됩니다.                                            |


장점
- **위험 최소화**
  전체 사용자에게 배포하기 전에 소수 사용자로부터 피드백을 얻을 수 있어 문제 발생 시 영향을 최소화할 수 있습니다.
- **신속한 롤백**
  문제가 발생하면 빠르게 롤백하여 서비스 중단을 최소화할 수 있습니다.
- **점진적 배포**
  새로운 기능이나 변경사항을 점진적으로 배포하여 사용자 경험을 개선할 수 있습니다.


단점
배포 진행 간 구/신 버전 공전으로 인해 호환성 문제가 발생할 수 있습니다.



# Reference

릴리즈? 포인트 릴리즈, 롤링 릴리즈
https://chobowarrior.tistory.com/28

무중단 배포란 무엇인가? 롤링 / 블루-그린 / 카나리 배포
https://digitalbourgeois.tistory.com/231

무중단배포 전략 설계하기 (+실제 프로젝트 적용)
https://yubi5050.tistory.com/200

무중단 배포란?(Rolling, BlueGreen, Canary)
https://hoehen-flug.tistory.com/53

## 실제 사례 모음
무중단 배포 도입기
https://ppaksang.tistory.com/24

도커로 해보는 무중단 배포
https://sinabroit53.tistory.com/44

정말 무중단 배포일까? 실제로 블루-그린 배포를 적용해본 사례
https://3juhwan.tistory.com/47


