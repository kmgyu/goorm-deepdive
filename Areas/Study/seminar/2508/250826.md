수호님 발표

스프링 데이터 jpa

순수한 jpa 기반 리포지토리

만든거 또만들고 또만들고 또만들고
지루하고 현학적임

repository 인터페이스 제공

spring data jpa가 런타임에 프록시 기반 실제 구현 클래스를 생성해주고, 인터페이스에 주입해줌
memberRepository.getClass() 이런식으로 해주면 그 프록시 객체가 나온다.

@Repository 생략 가능
JpaRepository 때문같다고 하심.
컴포넌트 스캔을 스프링 데이터가 jpa가 자동으로 처리
jpa 예외를 스프링 예외로 변환하는 과정도 자동 처리

스프링 데이터
repository
최상위 부모

CrudRepository
CRUD 메소드 정의됨

PagingAndSortingRepository
페이징이랑 정렬 기능도 지원함.

스프링 데이터 JPA
paging...리포지토리 상속
더 특화된 메소드 제공
findAll (다가져와)
saveAll 등...

지원하는 쿼리메소드 기능 3가지
1. 메소드 이름으로 쿼리 생성 가능
2. 메소드 이름으로 JPA NamedQuery 호출 가능
3. @Query 어노테이션 사용해 레조피토리 인터페이스에 쿼리 직접정의



메소드 이름으로 쿼리생성
스프링 데이터 JPA는 JPQL 같은 거 생각할 필요 없이 그냥 이름대로 써주면 알아서 시행됨. 네이밍컨벤션있다.

JPANamedQuery
@NamedQuery라는 어노테이션
query 패러미터로 JPQL 입력해줌

@Query, 리포지토리 메소드에 쿼리 정의하기
메소드에 JPQL 쿼리 작성


jpa 활용에서 느낀 점?
getter, setter
엔티티 데이터 조회할 일이 너무 많아서 getter는 열어둔다.
getter는 열어둘 일 많아서 상관없다.
setter는 데이터 변하기 때문에 열어두면 왜 변했는지 추적 감지가 힘듬.
변경 지점이 명확하도록 비즈니스 메소드를 만들어야 함.

준영속 컨텍스트
더이상 관리안함
관리하는 방법? 변경감지와 병합
트랜잭션 커밋 시점에 변경되도록 업데이트를 날린다?

변경 감지와 병합

병합?

병합 시 엔티티를 찾도록 조회한다. 1차 캐시 엔티티를 찾고, 영속상태인 엔티티를 찾는다. 없으면 DB에서 조회한다. 그건 몰루
영속 엔티티를 비영속 엔티티의 값으로 채운다.
그리고 반환한다.

없으면 null로 업데이터하기 때문에 변경감지를 사용한다고 함.

만약 병합 과정에서 롤백이 일어나면 어떻게 함?
준영속 상태에 대한 업데이트가 끝났는데, 롤백이 일어나려면?
상태 관련된 데이터가 업데이트가 됬다면 그 데이터는 휘발될 것 같은데, 따로 관리하는 것이 있나?
백엔드 측에서 전부 휘발되었으니 DB에서 관리를 해준다.
플러시/커밋 전 후 시점으로 나뉨
플러시 이전
DB에서 다시 불러오면 됨
플러시 이후
DB에 SQL 날아갔어도 트랜잭션이 커밋되지 않았으므로 취소하면 롤백된다. 종료 시 컨텍스트 clear됨. 다시 조회하면 원래보던 DB~
커밋 이후
트랜잭션 확정. 복구 불가.

낙관적 락?


OSIV

켜져있는 게 기본 동작
요청 시점부터 렌더링 종료시점까지 영속성 컨텍스트 살아있음.

인터셉터-컨트롤러-뷰-인터셉터 단은 수정 불가능
서비스-리포지토리 단은 수정 가능

꺼져있으면?
~컨트롤러단 준영속 상태

트랜잭션 범위에서 영속 상태

끄게 되면 리소스는 효율적인데, 모든 지연로딩을 트랜잭션 안에서 처리해야 한다. 많은 지연로딩 코드를 트랜잭션 안에 넣어줘야 하는 단점이 있다.
트랜잭션이 끝나기 전에 지연로딩 강제 호출해줘야 함.

관리자 페이지, 내부 시스템은 OSIV 켜서 편의성 우선
실시간 시스템 등은 꺼서 안정성과 성능을 높인다?

---

어떤 기능을 OFF 하는 것에 있어서 장단점이 있다. 그렇다면 on/off를 하는 것에 있어서 어떻게 접근하고 선정할 것인가?

데이터 양, 리소스가 기준이 될 수 있다.

프로세스가 들어가는 앞 뒤에다 로깅 시스템이나 모니터링하는 테스트 코드 같은 것, 실제 데이터를 이용한 검증 등 할 듯?

OSIV는 트랜잭션을 계속 물고 있다.
커넥션 풀에서 끌어다 사용하니 어느정도 리소스 안쪽에서는 대응 가능.
특정 범위 안쪽, 100번까진 괜찮은데 101번에서 대기해야 하는 상황이다. 같은 것을 검증을 해볼 듯?
데이터 양이나 서비스 측면에서 문제가 있다면 off 해서 개선해보는 방법이 있을 수 있다.

이런 기술 같은 것을 적용하거나 하는 검증방법에 대해 확실하게 테스트하고 적용하는 습관을 들여보시옹.
정확한 데이터로 승부보기


