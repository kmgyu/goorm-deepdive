민성님 발표
GC - 2

어떤 상황에서 발생하고 어떻게 분석할 수 있는지?


OOM
메모리 관리 실패로 인한 힙 공간의 부족
런타임 시 발생하면 시스템 또는 어플리케이션이 중지된다

테스트 소스 코드
요청 할 때마다 리스트에 간단하게 할당해주는 식으로 진행

로깅해주다가 OOM 생기면 서버가 터지면서 로그 파일이 생기게 된다.

### IntelliJ Profiler?

인텔리제이는 어플리케이션에 Attatch Profiler를 붙여줄 수 있다.
Stop profiling and show results를 누르기 전까지 지속적으로 기록해준다.

~/memory-info에서 메모리정보 조회
allocate 조회할 때마다 10mb씩 계속해서 할당
=> 한번에 터뜨려보기
oom-test
결국 터져서 500 에러가 나타난다.

터미널에선 어떻게 보이나?
자동으로 터뜨리는 건 할당을 해주다 dump file created 로그 출력

java heap space라는 OOM이 발생
> OOM 자체도 여러가지임!

로그에서 java.lang.OutOfMemoryError라고도 발견가능함.

Profiler로 가보면 원인을 찾을 수 있다.
show 옵션에서 memory allocations로 메모리 할당되는 것을 확인할 수도 있다!
어떤 클래스?가 전체 공간에 대해 몇%를 차지하는지도 확인가능하고, 뭐때문에 터졌는지도 확인 가능

timeline으로 특정 작업 상황/시점에서 터졌는지 footstep으로 확인가능. stack trace

events
들어가게되면 VM을 확인가능
GC, Heap

힙
특정 시점 힙, commited, max 값이 확인가능
힙 메모리 부족할 경우 한번 확장시켜줄 수도 있다. 근데 이렇게 해도 안되면 OOM 터짐. 어디서 일어났는지 파악 가능!

G1 heap summary.
eden, s0, s1, old 같은 것들 메모리 확인 가능
디버깅 방법 중의 하나!

인텔리제이 툴로써 강력한 디버깅 기능을 제공함.

#### 설정법
스터디 자료 참고
dump file 기록하도록 한다?

### MAT (Memory Analyzer)
Eclipse에서 만든 프로그램
제일 많이 사용한다고 한다.

덤프파일 넣어주면 OOM 발생 시점부터 어떻게 터뜨렸는지 보여준다.

Overview에서 GC 루트 추적하거나, 스냅샷 밖으로 뺄건지, Memory Leak 위치 등 정확한 파악 위치 제공

OOM이 다양하게 발생하다보니 다양한 기능을 제공한다.

탭들
어디서 메모리를 가장 많이 사용했는지 히스토그램 탭

dominater tree
어떤 것 때문에 터졌는지 확인 가능한 트리 형태 제공?

unreachable objects
GC 대상인지 확인

thread_overview
스레드 확인

leak hunter
메모리 누수 발생 위치 발견
갯수, 용량 등 판단
리포트를 자동 작성해주는 것이 가장 강력한 기능.

suspects
스냅샷 형식으로 문제를 분석해 리포트 제공

---

정리

아래와 같은 것들을 분석함.
Retianed Size가 큰 객체들
GC root로부터 참조 경로
객체 수가 비정상적으로 많은 클래스
순환 참조 구조


OOM 원인
- Java heap space
힙영역 부족
- GC overhead limit exceeded
GC 사용 시 cpu 사용률 98% 초과.
- requested array size exceeds vm limit
힙 영역보다 더 큰 영역 배열 할당 시 발생
- metaspace
-> metaspace 영역 부족 시 발생
metaspace : 클래스 메타데이터가 저장되는 공간
jdk 7 이전에는 permgen 영역으로 불림. 힙 메모리에 적은 범위로 설정되었을 땐 GC가 너무 많이 발생해 영역을 메타스페이스 영역으로 변경
변경 이후 OS에서 제공하는 native 메모리 영역을 사용하므로 GC 수행하지 않고도 자동 크기 증가시켜 공간 확보
- unable to create native thread
-> 가용할 스레드가 존재하지 않을 경우 발생


> 문제에 대한 대처, 분석 방법에 있어 간단한 툴과 사용 방법을 설명함.

