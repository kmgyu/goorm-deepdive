준원님 발표
스프링 시큐리티

인증, 권한 부여 및 일반적인 공격으로부터 보호 기능을 제공함.

인증 아키텍처
1. Authentication
	1. 인증 프로세스 할 때 가장 먼저 인증 필터가 객체 만들어 사용자 인증 시 아이디 비밀번호를 저장해서 담는 토큰 객체
2. 보안 컨텍스트
	1. 인증 객체를 최종 성공한 인증 객체를 저장하고 인증 상태를 유지한다.
3. 인증 관리자
	1. 인증 필터가 인증 시도 시 가장 먼저 인증처리를 맡김, 관리
4. 인증 제공자
	1. AuthenticationManager로 부터 인증 처리를 다시 위임받음. 실행 총괄
5. 사용자 상세 서비스
	1. 이 클래스를 사용해 사용자 정보를 가져올 수 있음.
6. 사용자 상세
	1. 유저 객체를 사용할 수 있음

시큐리티 인증 / 인가 흐름도

서블릿 필터, Authentication, Authorization, Spring MVC

매우 복잡한 흐름도가 있다.
필터 프록시가 필터 체인 프록시로 넘김.

---

Authentication 단계
인증으로 당신 누구야! 하는 과정
신원 확인하는 거.

인증 수행되면 권한 부여. 이건 Authorization 단계

Authentication 은 인증 정보를 저장하는 토큰 개념 객체로 활용된다. SecurityContext를 통해 전역적으로 참조 가능.
SecurityContextHolder가 static으로 되어있음. 그래서 가능함.

구조!
Authentication은 Principal을 상속받는다.
Principal은 자바 api에 있음.

메서드들은 자격 증명, 인증 주체, 추가적인 세부사항 등의 getter
그리고 인증 상태 가져오는 것(isAuthenticated)과 인증 상태 설정하는 setter가 있다


인증 절차 흐름
AuthenticationFilter - Authentication - AuthenticationManager - Authentication

그리고 다시 역순으로 필터로 올라가서 시큐리티 컨텍스트 홀더가 가져감

인증 처리 전, 처리 후 Authentication 객체를 생성한다. 그래서 저렇게 됨.
근데 바로 필터로 던지면 되는 거 아닌가? 왜 저렇게 ㅗ디징?

흐름도 다시 살펴보면, 흐름 자체가 그냥 그렇게 되있음
필터로 바로 못 던진다.
흐름도랑 똑같이 구현 되있다. 스택 형식이라 바로 못던짐.

시큐리티 컨텍스트
- Authentication 저장
- ThreadLocal 저장소 사용
- 애플리케이션 전반에 걸친 접근성

시큐리티 컨텍스트 홀더
전략 패턴 사용
SecurityContextHolderStrategy 인터페이스를 사용한다.
mode_threadlocal (대문자로 변환하셈 ㅎ) 이게 기본전략이고
3가지 정도 있다.

inheritablethreadlocal : 부모 스레드로부터 자식 스레드로 보안 컨텍스트 상속하며 스레드 간 분산 실행하는 경우 유용하다고 함.
global : 전역적으로 단일 보안 컨텍스트 사용. 서버 환경에서 부적합


시큐리티 참조 및 삭제 시?
SecurityContextHolder.getContextHolderStrategy().getContext()
각 앱마다 다른 전략을 줘서 사용하기 때문에 버전업할 때 getter로 전략을 가져오도록 변경했다고 함.
삭제는 closeContext()

시큐리티컨텍스트 홀더랑 시큐리티 컨텍스트
전용 저장소에 시큐리티 컨텍스트를 저장하기 때문에 동시성 문제가 없다.
스레드 풀에서 운용되는 스레드일 경우 새로운 요청이더라도 기존 스레드 로컬이 재사용될 수 있기 때문에 클라이언트로 응답 직전에 항상 시큐리티 컨텍스트를 삭제해준다고 함.

각 스레드는 자신만의 독립적인 시큐리티컨텍스트를 가지게 되어 동시에 여러 요청이 들어와도 인증 정보가 섞이지 않게 된다!



AuthenticationManager
Authentication 객체 받아서 인증 절차 시켜주고, 완전히 채워진 Authentication을 생성해 반환

AuthenticationProvider 목록 중 인증 처리 요건에 맞는 Provider를 찾아 인증 처리 위임?


form 인증, httpBasic 인증, RememberMe 인증, OAuth2 인증 등...
이런 것들을 ProviderManager 에 매칭 시키면 적절한 Provider를 찾아준다?


JWT는 필터에서 커스텀 provider를 이용해 인증처리 해서 인증처리를 해주는 듯... 매니저가 없어서 필터 단위에서 일어난다.

인증/인가 쪽에서 일단 요청 보내서 검증했는데, 롤 나오면 미리 코드에 세팅해줘야 함? DB 접근 통해서 확인함?
경험 상 DB에 넣는 것으로 알고 있다!
확실하게 인증 프로세스가 끝나지 않았는데 이것 때문에 DB 접근을 해야 하는가? 라는 것은 보안 상 문제가 있을 수 있나?

jwt도 AuthenticationProvider가 있다!


스프링의 쿠키, 세션 동작 과정도 짚고 넘어가면 도움이 된다.
