기존 AppConfig는 기능 사용할 때마다 객체를 계속 생성한다.
객체 생성에 드는 비용때문에 비효율적임.


이걸 해결하기 위해 싱글톤 패턴을 사용한다.

객체를 1개만 생성하고, 공유하도록 설계하면 된다.

사용 케이스?
ex. 트랜잭션 시마다 DB 커넥션을 새로 이어주는 것...?
-> 그럼 대량 트랜잭션 처리할 때 스레드 쓰나? 병렬처리 같은 건 어떻게 되는 거지
> 그래서 Thread Safe하게 사용하는 방법이 있다...
> 정확히는 멀티쓰레드 환경에서 여러 개 쓰레드가 동시에 접근하려 할 때 동시성 문제 때문에 여러 인스턴스가 생성되는 문제...
> synchronized 키워드를 이용하면 lock 걸어줄 수 있음. 동기 처리가 다 그렇듯이 시간적인 성능이 떨어짐
> DCL(Double Checked Locking) 방식으로도 접근 가능하다. 이것도 문제 있다함. 그래서 volatile 키워드 이용하는 것도 있다.
> static 이용해서 컴파일 타임에(위의 것들은 전부 런타임) 클래스 로드할 때 미리 생성하는 방법도 있다.
> 다른 다양한 방법이 있다... 뭐뭐뭣... 더있다고,....

https://seunghyunson.tistory.com/281

디자인 패턴은 정말 너무 다양한 것 같다...

싱글톤 패턴의 구현 방법은 아주 다양함.
실습에서는 객체를 미리 생성해두는 안전한 방법을 사용한다.
생성 안되어있으면 생성하는 지연 생성 방법도 존재한다?

### 싱글톤 문제점
- 구현에 코드 자체가 많이 들어감
- 의존 관계상 클라이언트가 구체 클래스에 의존 -> DIP 위반
- 당연히 OCP 위반 문제도 같이 따라옴
- 테스트하기 어려움
- 내부 속성 변경 및 초기화 어려움
- private 생성자로 자식 클래스 만들기 어려움
- 유연성이 떨어짐 (DI 해주기 굉장히 어려움)
- 안티 패턴으로 불리기도 함.

장점
- 쉐어 가능함

싱글톤 컨테이너
스프링 컨테이너의 역할 중 하나

싱글톤 패턴을 적용하지 않아도, 객체 인스턴스를 싱글톤으로 관리함.
- 컨테이너는 객체를 하나만 생성해서 관리한다.
싱글톤 객체를 생성하고 관리하는 기능을 싱글톤 레지스트리라 한다.
이런 기능 덕분에 싱글톤 문제점을 제거하면서 객체 인스턴스를 싱글톤으로 관리함.
- 싱글톤 위한 지저분한 코드 들어가지 않아도 됨.
- DIP, OCP, 테스트, private 생성자로부터 자유롭게 싱글톤 사용 가능


싱글톤 컨테이너 적용 후?
요청 할 때마다 기존 객체 공유해서 효율적으로 사용한다.

스프링 기본 빈 등록 방식은 싱글톤입지만, 싱글톤 방식만 지원하는 것은 아니다. 요청시마다 새로운 객체 생성 후 반환하는 기능도 제공함.
빈 스코프에서 나온다.

HTTP 세션이랑 똑같은 라이프 사이클을 맞춘다거나 하는 빈의 생명주기 관리하는 걸 빈스코프라 한다!

싱글톤 방식 주의점
> 기술면접에서 자주 나온다?
- 스프링 같은 싱글톤 컨테이너를 사용할 때에도 똑같은 문제이다. 여러 클라이언트가 하나의 같은 객체 인스턴스를 공유하기 때문에 싱글톤 객체는 상태를 유지(stateful)하게 설계하면 안된다.
- 무상태(stateless)를 설계해야 한다.
	- 특정 클라이언트에 의존적인 필드가 있으면 안된다.
	- 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다.
	- 가급적 읽기만 가능해야 한다.
	- 필드 대신 자바에서 공유되지 않는 지역변수, 파라미터, threadLocal 등을 사용해야 한다.
- 스프링 빈의 필드에 공유 값을 설정하면 정말 큰 장애가 발생 가능하다.

ex) 계좌 정보에 대해서 싱글톤이 저장하게 되면, A가 주문, B가 주문, A가 조회 시 B의 계좌 정보가 나올 수도 있다? (멀티스레드 환경 아닐 때 예시로 든 것임)

내 결제내역에서 다른 사람 결제내역이 보이는 것들 등...
상속 관계 등 엮여있어서 이런 거 터지면 문제점 찾기 힘들어져서 코드 다 뒤집어야됨



### @Configuration과 싱글톤

```
@Bean
public A a() { return new A() }
```
이 코드는 싱글톤이 깨질까 안 깨질까?
-> 스프링 컨테이너에서는 안깨진다~

스프링 컨테이너는 이 문제를 어떻게 해결할까?

@Configurations과 바이트코드 조작의 마법
CGLIB라는 바이트코드 조작 라이브러리를 사용해서 AppConfig 클래스 상속받은 임의 다른 클래스를 만들고, 그 다른 클래스를 스프링 빈으로 등록한 것임....!
내가 등록한 애는 사라지고 새롭게 AppConfig@CGLIB라는 객체가 생성된다고 보면 됨.
이 임의 다른 클래스가 바로 싱글톤이 보장되도록 해줌.
CGLIB 내부 기술 자체는 매우 복잡하다고 함.

Enhancer by SpringCGLIB?
CGLIB?

AOP에서도 동일한 매터니즘 사용한다고 함.

@Configuration 안붙여도 되긴 하는데, 이건 CGLIB으로 보장해주지 못하게 됨.
앞에서 나왔던 문제처럼 싱글톤이 깨져버리게 됨...

@Autowired로 집어넣어주기도 된다.
스프링이 자동으로 의존관계 주입해주는 어노테이션

