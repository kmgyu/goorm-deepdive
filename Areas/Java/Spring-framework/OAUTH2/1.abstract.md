참고한 강의에서 사용하는 강의자료 및 코드
https://picturesque-staircase-f6e.notion.site/SNS-18223940dccf8011a6e3fc7b17e3a463?pvs=74
https://github.com/kimseonguk197/kakao_google_oauth_inflearn

문서 내 참고
[[250903-OAUTH2]]

OAuth는 accessToken을 제3자에게 받아오는 방식

사용자 이메일, 아이디가 필요한 건데 사용자에게 제3자 로그인을 시키고 인가코드를 받게 한다.

인가코드 지급하는 건 redirect 방식으로 줄 수 밖에 없다.
구글 서버 로그인으로 제어권이 넘어갔기 때문.
리디렉션은 바디를 넣어줄 수 없다.
그래서 보안이 좀 취약함.

## OAuth란?

![[OAuth_intro0.png]]

- Open Authorization으로 신뢰할 수 있는 제 3자 인증 제공자(예를들어 구글이나 카카오?)를 통해 프로필정보, 이메일등에 대한 접근 권한을 위임 받을 수 있도록 하는 인증 및 권한 프로토콜
- sns로그인은 사용자가 구글,카카오 등 sns서비스에 로그인을 하고, 이 로그인과 OAuth기술을 통해 사용자 정보를 해당 sns로부터 받아와 당사의 웹서비스에 회원가입 및 로그인처리

## OAuth의 주요 요소

### Accesstoken
- 구글 카카오 서버에 API 요청을 하기 위한 인증키
- accesstoken을 통해 sns로그인한 사용자 정보 조회 요청

### 인가 코드
- AccessToken을 발급받기 위한 키값
- sns로그인시 화면의 제어권이 제 3자로 넘어가기 때문에 redirect 형식으로 사용자 정보를 받아와야 한다
- HTTP 리다이렉트(302)는 GET요청으 발생시키므로 body를 포함할수 없다
- accesstoken또는 사용자 정보등 중요한정보를 url로 받게 되면 웹브라우저상에 남아 있을 보안 취약점 존재하므로 인가코드를 발급하여 accesstoken을 발급한다
### 스코프
- 구글이나 카카오 즉 제3자 서버로부터 받아올수 있는 이메일,프로필 정보등 사용자 정보의 범위
- 스코프는 인가코드를 받을 때부터 받고자 하는 사용자 정보의 범위를 지정하여 요청

## OAuth 구현방식

1. 프론트(인가코드), 서버(accesstoken) 발급 방식
2. 서버에서 인가코드, accesstoken 모두 발급 방식

ERD 설계

| 물리 키        | 논리 키      | nullable | default value  |
| ----------- | --------- | -------- | -------------- |
| id          | ID (PK)   | NOT NULL | auto_increment |
| name        | 이름        | NULL     |                |
| email       | 이메일       | NOT NULL |                |
| password    | 패스워드      | NULL     |                |
| role        | 역할        | NULL     | USER           |
| social_type | 소셜 로그인 종류 | NULL     |                |
| social_id   | 소셜 로그인 ID | NULL     |                |
일반적인 member entity 기반으로 소셜 로그인할 시 social_type, social_id값 저장
대부분 sns에서 사용자 고유 id 값을 사용자 정보로 제공한다.


### 프론트(인가코드), 서버(accesstoken) 발급 방식

![[OAuth_intro1.png]]


프론트에서 인가코드를 받고, 나머지 작업은 서버에서 처리하는 방식
서버에서 모두 발급하는 방식보다 더 많이 쓰이며, 장점이 더 많고 단점이 적은 방식이라고 함.

동작

- 프론트엔드에서 구글 로그인 화면을 구글에 요청
- 사용자가 해당 화면에서 구글 로그인
- 구글에서 내 프론트화면으로 인가코드를 url에 담아 redirect
- 인가코드를 프론트에서 Spring서버로 전달
- 서버에서 인가코드를 가지고, 구글서버로부터 api요청이 가능하도록 해주는 accesstoken 발급
- accesstoken을 통해 사용자 정보를 구글서버에 요청 후 인증
- 로그인된 사용자에게 jwt 토큰 발급

장점

- 사용자가 서버로 부터 jwt토큰을 받을 때 안전하게 바디를 통해 값을 받을수 있음
- 인가코드,accesstoken,사용자 정보 요청등 직접 요청에 의한 결과 값을 받는 방식을 통해 직관적이고,문제가 생겼으면 어디에 문제가 생겼는지 알수 있어서 좋다

단점

- 클라이언트에서 클라이언트 ID값을 보관하고 있어야하는 보안적 취약점
- 다만 클라이언트 ID값이 유출된다 하더라도 요청할수 있는 url이 지정되어있어 보안상 큰취약점은 아니다

### 서버에서 인가코드,accesstoken 모두 발급 방식

![[OAuth_intro2.png]]

스프링에 있는 oauth2-client의존성을 통해 서버에서 인가코드,토큰 발급,사용자 요청 모두처리

장점

- 스프링의 의존성을 통해 모든절차와 요청이 한꺼번에 진행되어 코드구현이 간결함
- clientID등 서버측에서 관리하므로 안전하게 보관할수있다

단점

- 최종적으로 사용자에게 jwt토큰을 줄때 redirect방식을 취할수 밖에 없어 보안상 취약점 존재한다
- 모든절차가 라이브러리를 통해 통합되어 있고,자동화가 되어 있어 코드파악의 어려움과 디버깅의 어려움 존재
- 인가코드가 redirect될때 인가코드 요청을 했던 동일서버가 아닌경우 문제발생

![[OAuth_intro3.png]]

로드밸런서에서 별도로 sticky옵션을 지정해줄 필요가 있다

JWT

![[OAuth_intro4.png]]
자체 회원 가입, 로그인 api도 개발하게 됨.
filter를 통한 토큰 검증 구현
